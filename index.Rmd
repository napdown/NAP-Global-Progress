---
title: "NAP Global Progress "
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
    source_code: https://github.com/napdown/countryprofiles
    theme: simplex
  
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(readxl)
library(magrittr)
library(plotly)
library(ggplot2)
library(dplyr)
library(reshape)
library(rpivotTable)
library(DT)
library(leaflet)
library(crosstalk)

```


```{r global}
tracker<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "tracker"))
colnames(tracker)[colnames(tracker)=="Standard measure based on progress report"]<-"Measure"
tracker$Element<-factor(tracker$Element, levels = c("Laying the ground work and addressing gaps", "Preparatory elements" ,"Implementation strategies" ,"Reporting monitoring and review"))
measures<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "Measures"))
measures$`Without Measure`<-154-(measures$`Developing Countries  (non-LDC)`+measures$LDCs)
GCF_accessed<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "GCF_Accessed"))
GCF_projects<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "GCF"))
categories<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "country_categories"))
NAPS <- as.data.frame(read_excel("Open_NAPs_Database.xlsm",sheet = "Submitted_NAPs"))
country_codes_un <- as.data.frame(read_excel("Open_NAPs_Database.xlsm",sheet = "country_codes_un"))
regions <- as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "Regions"))
iso_cat<- as.data.frame(read_excel("Open_NAPs_Database.xlsm",sheet = "country_categories"))
latlong <-as.data.frame(read_excel("Open_NAPs_Database.xlsm",sheet = "countrylatlong"))
Readiness<- as.data.frame(read_excel("Open_NAPs_Database.xlsm",sheet = "Readiness"))%>%dplyr::filter(Activity=='Adaptation Planning (AP)')
approvals<-as.data.frame(read_excel("Open_NAPs_Database.xlsm", sheet = "Readiness_Approval"))%>%na.omit()


#merge
GCF_merge<-merge(GCF_accessed, categories, by='countryname', all.x = T)
GCF_merge<-GCF_merge[,c(1,6,7,8,9,10,11)]

tracker_merge<-merge(tracker,categories, by='countryname', all.x = T)

unregions<-merge(country_codes_un, regions, by='countryname', all.x=TRUE)
unregions<-merge(unregions,iso_cat, by='countryname', all.x=TRUE)
NAPCountries<-merge(unregions,NAPS, by="countryname", all.y = TRUE)
xycountrycode<-merge(unregions,latlong, by='countryname', all.x = TRUE)
NAP_Countries<-merge(NAPS,xycountrycode, by="countryname", all.x = TRUE)

# data for crosstalk
df<-merge(GCF_accessed,regions, by="countryname")
df<-merge(df, Readiness, by="countryname", all.x=T)
df<-merge(df, approvals, by="countryname", all.x=T)
df<-merge(df, categories, by="countryname", all.x=T)
df<-df[,c(1,10,7,8,9,17,18,19,21,22,23,26,27,28,29,31,32)]

shared_df <- SharedData$new(df)

```


Progress to Formulate & Implement NAPS
==================================================================================
{.tabset}
-------------------------------------------------------------

### Measures General Outlook

```{r}
measures$Measure1wrap<-sapply(measures$Measure1, FUN = function(Measure1){paste(strwrap(Measure1, width = 79), collapse = "<br>")})

measures$Measure1wrap<-factor(measures$Measure1wrap, levels = unique(measures$Measure1wrap)[order(measures$Code, decreasing = TRUE)])

fig <- plot_ly(measures, x = ~LDCs, y = ~Measure1wrap, type = 'bar', orientation = 'h',  name = 'LDCs',
        marker = list(color = 'rgba(38, 24, 74, 0.8)'),text=~LDCs, textposition= 'top  right',textfont=list(size=12, color='white')) 

#,line = list(color = 'rgb(248, 248, 249)', width = 1)
fig <- fig %>% add_trace(x = ~`Developing Countries  (non-LDC)`,name='Developing Countries  (non-LDC)',  marker = list(color = 'rgba(71, 68, 131, 0.85)'),text=~`Developing Countries  (non-LDC)`, textposition= 'right',textfont=list(size=12, color='white')) 

fig <- fig %>% add_trace(x = ~`Without Measure`,name='Without Measure', marker = list(color = 'rgba(164, 163, 204, 0.95)'),text=~`Without Measure`, textposition= 'middle left',textfont=list(size=12, color='white')) 
fig <- fig %>% layout(xaxis = list(title = "No. of Countries",
                      showgrid = TRUE,
                      showline = FALSE,
                      showtext=T,
                      showticklabels = TRUE,
                      zeroline = FALSE,
                      domain = c(0.15, 1)),
         yaxis = list(title = "",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE),
         barmode = 'stack',
         paper_bgcolor = 'rgb(248, 248, 255)', plot_bgcolor = 'rgb(248, 248, 255)',
         margin = list(l = 200, r = 0, t = 10, b = 50),
         showlegend = TRUE, legend=list(orientation='h', x=0.2,y=-0.15))

# label yaxis
fig <- fig %>% add_annotations(xref = 'paper', yref = 'y', x = 0.14, y = ~Measure1wrap,
                  xanchor = 'right',
                  text = measures$Measure1wrap,
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE, align = 'center') 



fig

```

### Measures Outlook - Grouped
```{r}
A <- list(
  x = 2.5,
  y = 30,
  text = "Laying the groundwork \nand addressing gaps",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

B <- list(
  x = 2.5,
  y = 30,
  text = "Preparatory elements",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

C <- list(
  x = 2.0,
  y = 30,
  text = "Implementation strategies",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

D <- list(
  x = 2.0,
  y = 30,
  text = "Reporting, monitoring and review",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)


mdf<-as.data.frame(measures[,c(1,4,5,7,6,8)])%>%reshape::melt(id.vars=c('Element', 'Measure1', 'Code'))

mdf$Measure1wrap<-sapply(mdf$Measure1, FUN = function(Measure1){paste(strwrap(Measure1, width = 45), collapse = "<br>")})

mdf$Measure1wrap<-factor(mdf$Measure1wrap, levels = unique(mdf$Measure1wrap)[order(mdf$Code, decreasing = F)])

plotA<-mdf%>%filter(Element=="A. Laying the groundwork and addressing gaps")%>%plot_ly(type='bar',y=~value,x=~Measure1wrap, color = ~variable, colors = c('#261C4A', '#47448A','#A4A3CC'),text=~value, textposition= 'middle',textfont=list(size=12, color='white'), showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "A. Laying the groundwork and addressing gaps"),yaxis=list(title='No. of Countries'))

plotB<-mdf%>%filter(Element=="B. Preparatory elements")%>%plot_ly(type='bar',y=~value,x=~Measure1wrap,text=~value, textposition= 'bottom middle',textfont=list(size=12, color='white'), color = ~variable, colors = c('#261C4A', '#47448A','#A4A3CC'), showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "B. Preparatory elements"),yaxis=list(title='No. of Countries'))

plotC<- mdf%>%filter(Element=="C. Implementation strategies")%>%plot_ly(type='bar',y=~value,x=~Measure1wrap,text=~value, textposition= 'middle',textfont=list(size=12, color='white'), color = ~variable, colors = c('#261C4A', '#47448A','#A4A3CC'), showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "C. Implementation strategies"),yaxis=list(title='No. of Countries'))

plotD<-mdf%>%filter(Element=="D. Reporting, monitoring and review")%>% plot_ly(type='bar',y=~value,x=~Measure1wrap, text=~value, textposition= 'middle',textfont=list(size=12, color='white'), color = ~variable, colors = c('#261C4A', '#47448A','#A4A3CC'),  showlegend=T)%>%
  plotly::layout(legend=list(orientation='h', x=0.3, y=1.05), barmode='stack', xaxis = list(title = "D. Reporting, monitoring and review"),yaxis=list(title='No. of Countries'))


subplot(plotA, plotB,plotC, plotD, shareY = T, shareX = T, titleY = T, margin = 0.01)%>%layout(barmode='stack')


```

###### ggplot - delete

```{r}
library(gridExtra)
library(grid)
library(gtable)
mdf$Measure1wrap<-sapply(mdf$Measure1, FUN = function(Measure1){paste(strwrap(Measure1, width = 35), collapse = "\n")})

mdf$Measure1wrap<-factor(mdf$Measure1wrap, levels = unique(mdf$Measure1wrap)[order(mdf$Code, decreasing = T)])

a<-mdf%>%filter(Element=="A. Laying the groundwork and addressing gaps")%>%
  ggplot()+
  geom_bar(aes(y=Measure1wrap, x=value, fill=variable, text = value, textposition='top'), stat = 'identity', position = 'stack')+
  labs(x='', y='A. Laying the \ngroundwork and \naddressing gaps')+
  theme(legend.position = 'none',axis.text.x = element_blank(),  axis.ticks.x = element_blank())
b<-mdf%>%filter(Element=="B. Preparatory elements")%>%
  ggplot()+
  geom_bar(aes(y=Measure1wrap, x=value, fill=variable), stat = 'identity', position = 'stack')+
  labs(x='', y='B. Preparatory\n elements')+
  theme(legend.position = 'none',axis.text.x = element_blank(),  axis.ticks.x = element_blank())
c<-mdf%>%filter(Element=="C. Implementation strategies")%>%
  ggplot()+
  geom_bar(aes(y=Measure1wrap, x=value, fill=variable), stat = 'identity', position = 'stack')+
  labs(x='', y='C. Implementation\n strategies')+
  theme(legend.position = 'none',axis.text.x = element_blank(),  axis.ticks.x = element_blank())
d<-mdf%>%filter(Element=="D. Reporting, monitoring and review")%>%
  ggplot()+
  geom_bar(aes(y=Measure1wrap, x=value, fill=variable), stat = 'identity', position = 'stack')+
  labs(x='No. of Countries', y='D. Reporting,\n monitoring \n and review')+
  theme(legend.position = 'bottom', legend.direction = 'horizontal', legend.title = element_blank())


#grid.arrange(a,b,c,d, nrow=4, ncol=1)
a1<-ggplotGrob(a)
b1<-ggplotGrob(b)
c1<-ggplotGrob(c)
d1<-ggplotGrob(d)
g<-rbind(a1,b1,c1,d1, size='last')
g$widths <- unit.pmax(a1$widths, b1$widths,c1$widths, d1$widths)
grid.newpage()
grid.draw(g)

```

###### OTHER G 
```{r}
ggplot(mdf)+
  geom_bar(stat = 'identity', position = 'stack', aes(x=value, y=Measure1, fill=variable))+
  facet_grid(vars(Element) )
```


Select Measures
=========================================================================================
{.tabset }
---------------------------------------------
### General Outlook
```{r}
mselect<-measures%>%dplyr::filter(Code=='A1'|Code=='A2'|Code=='A3'|Code=='A8'|Code=='A9'|Code=='B3'|Code=='B7'|Code=='C3'|Code=='D4')

mselect$Measure1<-factor(mselect$Measure1, levels = unique(mselect$Measure1)[order(mselect$Code, decreasing = TRUE)])

mselect$Measure1wrap<-sapply(mselect$Measure1, FUN = function(Measure1){paste(strwrap(Measure1, width = 60), collapse = "<br>")})

fig <- plot_ly(mselect, x = ~LDCs, y = ~Measure1, type = 'bar', orientation = 'h', text=~LDCs, textposition= 'left',textfont=list(size=12, color='white'), name = 'LDCs',
        marker = list(color = 'rgba(38, 24, 74, 0.8)')) 

fig <- fig %>% add_trace(x = ~`Developing Countries  (non-LDC)`,name='Developing Countries (non-LDC)', marker = list(color = 'rgba(71, 68, 131, 0.85)'),text=~`Developing Countries  (non-LDC)`, textposition= 'right',textfont=list(size=12, color='white')) 

fig <- fig %>% add_trace(x = ~`Without Measure`,name='Without Measure', marker = list(color = 'rgba(164, 163, 204, 0.95)'),text=~`Without Measure`, textposition= 'middle',textfont=list(size=12, color='white')) 
fig <- fig %>% layout(xaxis = list(title = "No. of Countries",
                      showgrid = TRUE,
                      showline = FALSE,
                      showtext=T,
                      showticklabels = TRUE,
                      zeroline = FALSE,
                      domain = c(0.15, 1)),
         yaxis = list(title = "",
                      showgrid = FALSE,
                      showline = FALSE,
                      showticklabels = FALSE,
                      zeroline = FALSE),
         barmode = 'stack',
         paper_bgcolor = 'rgb(248, 248, 255)', plot_bgcolor = 'rgb(248, 248, 255)',
         margin = list(l = 200, r = 0, t = 10, b = 50),
         showlegend = TRUE, legend=list(orientation='h', x=0.2,y=-0.15))

# label yaxis
fig <- fig %>% add_annotations(xref = 'paper', yref = 'y', x = 0.14, y = ~Measure1,
                  xanchor = 'right',
                  text = mselect$Measure1wrap,
                  font = list(family = 'Arial', size = 12,
                            color = 'rgb(67, 67, 67)'),
                  showarrow = FALSE, align = 'center') 



 
fig

```

#### Important Measures -  general

```{r}
#selected_measures<-measures%>%dplyr::filter(Code=='A1'|Code=='A2'|Code=='A3'|Code=='A8'|Code=='A9'|Code=='B3'|Code=='B7'|Code=='C3'|Code=='D4')
selected_measures<-tracker_merge%>%dplyr::filter(`Measure code`=='A1'|`Measure code`=='A2'|`Measure code`=='A3'|`Measure code`=='A8'|`Measure code`=='A9'|`Measure code`=='B3'|`Measure code`=='B7'|`Measure code`=='C3'|`Measure code`=='D4')

df1<-selected_measures%>%group_by(Element,Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

df1$Measurewrap<-sapply(df1$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 40), collapse = "<br>")})
df1$Measurewrap<-factor(df1$Measurewrap, levels = unique(df1$Measurewrap)[order(df1$`Measure code`,decreasing = F)])

plot_ly(df1,type='bar',x=~Measurewrap, y=~Countries, text=~Countries, textposition='auto', color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "Measure"),yaxis=list(title='No. of Countries'))

```


### By Region

```{r}

aftitle <- list(
  x = 2.5,
  y = 30,
  text = "Africa",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

asiatitle <- list(
  x = 2.5,
  y = 30,
  text = "Asia-Pacific",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

lactitle <- list(
  x = 2.5,
  y = 30,
  text = "Latin America &\nthe Caribbean",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

eutitle <- list(
  x = 2.5,
  y = 30,
  text = "Eastern Europe",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)


africa<-selected_measures%>%filter(Region=='Africa')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

africa$Measurewrap<-sapply(africa$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 55), collapse = "<br>")})

africa$Measurewrap<-factor(africa$Measurewrap, levels = unique(africa$Measurewrap)[order(africa$`Measure code`,decreasing = F)])

af_plot<-plot_ly(africa,type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(annotations=aftitle, barmode='stack', xaxis = list(title = ""),yaxis=list(title='No. of Countries', showline=T, linecolor='black',mirror=F, linewidth=2))


asia_pacific<-selected_measures%>%filter(Region=='Asia-Pacific')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

asia_pacific$Measurewrap<-sapply(asia_pacific$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 55), collapse = "<br>")})

asia_pacific$Measurewrap<-factor(asia_pacific$Measurewrap, levels = unique(asia_pacific$Measurewrap)[order(asia_pacific$`Measure code`,decreasing = F)])

asia_plot<-plot_ly(asia_pacific, type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(annotations=asiatitle, barmode='stack', xaxis = list(title = ""),yaxis=list(title='No. of Countries', showline=T,mirror=F, linecolor='black', linewidth=2))


lac<-selected_measures%>%filter(Region=='LAC')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

lac$Measurewrap<-sapply(lac$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 55), collapse = "<br>")})

lac$Measurewrap<-factor(lac$Measurewrap, levels = unique(lac$Measurewrap)[order(lac$`Measure code`,decreasing = F)])

lac_plot<-plot_ly(lac,type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(annotations=lactitle, barmode='stack', xaxis = list(title = ""),yaxis=list(title='No. of Countries', showline=T,mirror=F, linecolor='black', linewidth=2))


eu<-selected_measures%>%filter(Region=='Eastern Europe')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

eu$Measurewrap<-sapply(eu$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 55), collapse = "<br>")})

eu$Measurewrap<-factor(eu$Measurewrap, levels = unique(eu$Measurewrap)[order(eu$`Measure code`,decreasing = F)])

eu_plot<-plot_ly(eu,type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(annotations=eutitle, barmode='stack', xaxis = list(title = ""),yaxis=list(title='No. of Countries', showline=T,mirror=F, linecolor='black', linewidth=2))


plotly::subplot(af_plot, asia_plot,lac_plot,eu_plot, titleX = T,shareY = T, margin = 0.01)%>% layout(barmode = 'stack',plot_bgcolor='#e5ecf6')

```

#### Important Measures by Country Category

```{r}

ldc<-selected_measures%>%filter(Category=='LDC')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
ldc_plot<-plot_ly(ldc,type='bar',x=paste(ldc$`Measure code`, substr(ldc$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "LDC"),yaxis=list(title='No. of Countries'))


sids<-selected_measures%>%filter(Category=='SIDS')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
sids_plot<-plot_ly(sids, type='bar',x=paste(sids$`Measure code`, substr(sids$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "SIDS"),yaxis=list(title='No. of Countries'))


ldc_sids<-selected_measures%>%filter(Category=='LDC, SIDS')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
ldc_sids_plot<-plot_ly(ldc_sids, type='bar',x=paste(ldc_sids$`Measure code`, substr(ldc_sids$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues', showlegend=T)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "LDC,SIDS"),yaxis=list(title='No. of Countries'))


lldc<-selected_measures%>%filter(Category=='LLDC')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
lldc_plot<-plot_ly(lldc, type='bar',x=paste(lldc$`Measure code`, substr(lldc$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "LLDC"),yaxis=list(title='No. of Countries'))


ldc_lldc<-selected_measures%>%filter(Category=='LDC, LLDC')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
ldc_lldc_plot<-plot_ly(ldc_lldc, type='bar',x=paste(ldc_lldc$`Measure code`, substr(ldc_lldc$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "LDC,LLDC"),yaxis=list(title='No. of Countries'))


otherdc<-selected_measures%>%filter(Category=='Other developing country')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))
otherdc_plot<-plot_ly(otherdc,type='bar',x=paste(otherdc$`Measure code`, substr(otherdc$Measure, 1,40), '...',sep = '-'),y=~Countries, color = ~Measure, colors = 'Blues',legendgroup=~Measure, showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "Other DC"),yaxis=list(title='No. of Countries'))


plotly::subplot(ldc_plot,sids_plot,ldc_sids_plot,lldc_plot,ldc_lldc_plot,otherdc_plot, titleX = T,shareY = T)%>% layout(barmode = 'stack', showlegend = F)


```

### By Country Category

```{r}
ldctitle <- list(
  x = 3,
  y = 35,
  text = "LDCs",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)

otherdctitle <- list(
  x = 3,
  y = 35,
  text = "Other Developing Countries",
  xref = "x",
  yref = "y",
  showarrow = F,
  arrowhead = 7,
  ax = 20,
  ay = -40
)




ldc<-selected_measures%>%filter(Category2=='LDC')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

ldc$Measurewrap<-sapply(ldc$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 20), collapse = "<br>")})

ldc$Measurewrap<-factor(ldc$Measurewrap, levels = unique(ldc$Measurewrap)[order(ldc$`Measure code`,decreasing = F)])

ldc_plot<-plot_ly(ldc,type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F)%>%
  plotly::layout(annotations=ldctitle, barmode='stack', xaxis = list(title = " "),yaxis=list(title='No. of Countries'))


otherdc<-selected_measures%>%filter(Category2=='Other developing country')%>% group_by(Measure,`Measure code`)%>%count(Country)%>%
  summarise('Countries'=sum(n))

otherdc$Measurewrap<-sapply(otherdc$Measure, FUN = function(Measure){paste(strwrap(Measure, width = 20), collapse = "<br>")})

otherdc$Measurewrap<-factor(otherdc$Measurewrap, levels = unique(otherdc$Measurewrap)[order(otherdc$`Measure code`,decreasing = F)])

otherdc_plot<-plot_ly(otherdc,type='bar',x=~Measurewrap,y=~Countries, color = ~Measure, colors = 'Blues', showlegend=F, name='Other DC')%>%
  plotly::layout(annotations=otherdctitle,barmode='stack', xaxis = list(title = ""),yaxis=list(title='No. of Countries'))



plotly::subplot(ldc_plot,otherdc_plot, titleX = T,shareY = T, margin = 0.01)%>% layout(barmode = 'stack', plot_bgcolor='#e5ecf6', showlegend = F)


```

###### Measures Select- Outlook

```{r}
mshort<-selected_measures[,c(3,5,6,7,8,19)]%>%group_by(Measure, Category2, `Measure code`)%>%count(Country)%>%summarise("Countries"=sum(n))
mshort$`Measure code`<-factor(mshort$`Measure code`, levels = unique(mshort$`Measure code`)[order(mshort$`Measure code`, decreasing = TRUE)])
#mshort%>%group_by(Measure)%>%count(Country)%>%summarise("Countries"=sum(n))
plot_ly(mshort, type='bar', x=~Countries, y=paste(mshort$`Measure code`,':', substr(mshort$Measure, 1, 40), '...'), fill=~Category2, color = ~Category2)%>%plotly::layout(barmode='stack')

#ggplot(mshort)+
 # geom_bar(stat = 'identity', aes(x=Countries, y=paste(mshort$`Measure code`, ':', substr(mshort$Measure, 1, 40), '...'), fill=Category2, #colour=Category2))
```


Find full of measures[here](do we have a sharable link for the measures?)

NAP Submissions
========================================================

### Countries with submitted NAPS

```{r, warning=FALSE, message=F}


NAP_Countries$`Document title`<-paste('<a href=',NAP_Countries$Link, '>',NAP_Countries$`Document title`,'</a>', sep = "")

NAP_Countries<-NAP_Countries%>%
   mutate(popup_info=paste(countryname,"<br>","Submitted on:",NAP_Countries$`Date of submission`,"<br>","Title:",NAP_Countries$`Document title`))

leaflet(NAP_Countries)%>%setView(lng= 35.79, lat= -9.71 , zoom = 2.5)%>%
  addTiles()%>%
  setMaxBounds(0,-60,90,60)%>%
  addCircleMarkers(data=NAP_Countries, fill=T,lng=~lon, lat =~lat, radius = 6, color='red', popup =~popup_info)%>%
  addMiniMap()
 
 
```

##### List
```{r}
NAPS$`Document title`<-paste('<a href=',NAPS$Link, '>',NAPS$`Document title`,'</a>', sep = "")

colnames(NAPS)[colnames(NAPS)=='countryname']<-'Country'
#colnames(GCF_projects)[colnames(GCF_projects)=='Region_init']<-'Region'
naps<-NAPS[,-4]
datatable(naps,filter = 'top',selection = 'multiple',callback = JS("return table;"), fillContainer = T,rownames = F, editable = F, style = 'jqueryui', class = 'display responsive', width = '100%', caption = "GCF Projects", extensions = 'Buttons', options=list(initComplete = JS("function(settings, json) {$(this.api().table().header()).css({'font-size' : '70%'});}"),pageLength= 10, dom='lfrtipB', buttons = c('copy', 'csv', 'excel', 'pdf')), escape = F)%>%
  DT::formatStyle(columns = colnames(naps),fontSize= '12px')
 
```



GCF Resources
===============================================================
{.tabset}
---------------------------------------------------------------

### Total Funding - by Country

```{r}
country_tot<-GCF_merge%>%dplyr::filter(`Grand Total GCF`>0.0)%>%group_by(countryname)%>%summarise('Total'=sum(`Grand Total GCF`))

country_tot$countryname <- factor(country_tot$countryname, levels = unique(country_tot$countryname)[order(country_tot$Total, decreasing =T)])

p<-ggplot(country_tot)+
  geom_bar(stat='identity', aes(x=countryname,y=Total), colour='white',fill='blue')+
  labs(x='Country', y='Amount Accessed (Million USD)')+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 13), axis.text.y = element_text(size = 13), axis.title.y = element_text(size = 13), axis.title.x = element_blank())
ggplotly(p)

```


### Total Funding - LDC
```{r}
ldc<-GCF_merge%>%filter(Category2=='LDC')%>% filter(`Grand Total GCF`>0.0)%>% group_by(countryname, Category2)%>%summarise('Total'=sum(`Grand Total GCF`))
ldc$countryname <- factor(ldc$countryname, levels = unique(ldc$countryname)[order(ldc$Total, decreasing = TRUE)])

plot_ly(ldc,type='bar',x=~countryname,y=~Total, color = ~Category2, colors = 'Blue', showlegend=F)%>%
  plotly::layout(barmode='stack', xaxis = list(title = "", tickangle=90, tickfont=list(size=22)),yaxis=list(range=c(0,450), tickfont=list(size=20), title='Total Amount ((Million USD)', titlefont=list(size=20)))
```

### Total Funding - Other DC
```{r}
otherdc<-GCF_merge%>%filter(Category2=='Other developing country')%>% filter(`Grand Total GCF`>0.0)%>% group_by(countryname, Category2)%>%summarise('Total'=sum(`Grand Total GCF`))
otherdc$countryname <- factor(otherdc$countryname, levels = unique(otherdc$countryname)[order(otherdc$Total, decreasing = TRUE)])

plot_ly(otherdc,type='bar',x=~countryname,y=~Total, color = ~Category2, colors = 'Blue', showlegend=F)%>%
 plotly::layout(barmode='stack', xaxis = list(title = "", tickangle=90, tickfont=list(size=15.85)),yaxis=list(range=c(0,450), tickfont=list(size=18), title='Total Amount ((Million USD)', titlefont=list(size=18)))
```

```{r}

ldc1<-ldc
ldc1$Total<-as.integer(ldc1$Total)
write.table(ldc1, file = 'ldc1.txt', sep = "", row.names = F)

otherdc1<-otherdc
otherdc1$Total<-as.character(otherdc1$Total)
write.table(otherdc1, file = 'otherdc1.csv', sep = "", row.names = F)

```

##### Project Funding

```{r}

country_proj<-GCF_merge%>%dplyr::filter(`Total GCF financing (projects)`>0.0)%>%group_by(countryname)%>%summarise('Total'=sum(
  `Total GCF financing (projects)`
))

country_proj$countryname <- factor(country_proj$countryname, levels = unique(country_proj$countryname)[order(country_proj$Total, decreasing = F)])

  plot_ly(data=country_proj, type='bar', 
          y=~countryname,
          x=~Total)%>%
    plotly::layout(title='Total Project Financing - by Country',yaxis=list(title=''), xaxis=list(title='Project Amount ((Million USD)'))
```


Readiness
=====================================================
{.tabset}
---------------------------------------------------------------

### Total Readiness Accessed

```{r}

country_red<-GCF_merge%>%dplyr::filter(`Grand Total GCF`>0.0)%>%group_by(countryname)%>%summarise('Total'=sum(`Readiness support approved`))

country_red$countryname <- factor(country_red$countryname, levels = unique(country_red$countryname)[order(country_red$Total, decreasing = F)])

  plot_ly(data=country_red, type='bar', 
          y=~countryname,
          x=~Total)%>%
    plotly::layout(title='Readiness Amount Approved - by Country',yaxis=list(title=''), xaxis=list(title='Readiness Amount Approved (Million USD)'))
```


### Readiness Amount by Delivery partner
as at Nov 2020?

```{r, fig.width=20}
tot<-Readiness%>%
  group_by(`Delivery Partner`,`Delivery Partner_long` )%>%
  summarise("Total Approved"=sum(`Amount Approved`))

mylabel <- paste(tot$`Delivery Partner`,paste('$',prettyNum(format(tot$`Total Approved`,big.mark = ","), "", sep = ",")),  sep = " \n")

plot_ly(tot)%>%
  add_pie(hole=0.4, labels = ~`Delivery Partner_long`, values = ~`Total Approved`, text=mylabel, textinfo='text',rotation=-270) %>%
  layout(title="Readiness Amount Approved - by Delivery Partner",
           legend=list(orientation='h', x=0, y=-0.9))
```

### Readiness Amount Approved/Disbursed - by delivery partner
as at Nov 2020?
```{r}
del_p<-Readiness%>%
  group_by(`Delivery Partner_long`)%>%
  summarise("Total Approved"=sum(`Amount Approved`), "Total Disbursed"=sum(`Amount Disbursed`))

del_p$`Delivery Partner_long` <- factor(del_p$`Delivery Partner_long`, levels = unique(del_p$`Delivery Partner_long`)[order(del_p$`Total Approved`, decreasing = F)])
del_p$`Delivery Partner_long` <- factor(del_p$`Delivery Partner_long`, levels = unique(del_p$`Delivery Partner_long`)[order(del_p$`Total Disbursed`, decreasing = F)])

plot_ly(del_p, type = 'bar', y=~`Delivery Partner_long`, x=~`Total Disbursed`, name='Amount Disbursed')%>%
  add_trace( x=~`Total Approved`,name='Amount Approved')%>%
  layout(xaxis=list(title='USD Amount'), yaxis=list(title='Delivery Partner'))
```

### Approval Timeline
```{r}
approvals$countryname <- factor(approvals$countryname, levels=approvals$countryname[order(approvals$`Time-to-approve (Months)`)] )

fig <- plot_ly(approvals, color = I("gray60"))
fig <- fig %>% add_segments(y = ~`Date of initial submission`, yend = ~Approval, x = ~countryname, xend = ~countryname, showlegend = FALSE)
fig <- fig %>% add_segments(y = ~`Date of initial submission`, yend = ~`Last date of resubmission`, x = ~countryname, xend = ~countryname, showlegend = FALSE)
fig <- fig %>% add_segments(y = ~`Last date of resubmission`, yend = ~Approval, x = ~countryname, xend = ~countryname, showlegend = FALSE)
fig <- fig %>% add_markers(y = ~`Date of initial submission`, x = ~countryname, name = "Initial submission", color = I("red"))
fig <- fig %>% add_markers(y = ~`Last date of resubmission`, x = ~countryname, name = "Resubmission", color = I("blue"))
fig <- fig %>% add_markers(y = ~Approval, x = ~countryname, name = "Approval", color = I("green"))
fig <- fig %>% layout(
    title = "Time Taken To Approve GCF Readiness Funds",
    xaxis = list(title = ""),
    yaxis = list(title = "Date"),
    margin = list(l = 10)
  )

fig

```

GCF Resources - Interactive
=============================================
column
----------------------------------------

### Total GCF by Country
```{r}
shared_df <- SharedData$new(df)

bscols(widths = c(2,2),
  list(filter_select("Region", "Filter by Region", shared_df, ~Region, multiple=TRUE),filter_checkbox("Country Category", "Filter by Category", shared_df, ~Category2,columns = 1),filter_select("Cat2", "More Categories", shared_df, ~Category, multiple=TRUE)),
  plot_ly(shared_df, x=~countryname,y=~`Grand Total GCF`, showlegend=F, width = "100%")%>%
          plotly::layout(title='', xaxis = list(title = "", tickangle=90, tickfont=list(size=12)),yaxis=list( tickfont=list(size=14), title='Amount ((Million USD)', titlefont=list(size=14)))
  
)
```

### Readiness by Delivery Partner
```{r}
mylabel <- paste(df$`Delivery Partner`,paste('$',prettyNum(format(sum(df$`Readiness support approved`),big.mark = ","), "", sep = ",")),  sep = " \n")

bscols(
  shared_df%>% 
  plot_ly()%>%
  add_pie(hole=0.4, labels = ~`Delivery Partner_long`, values = ~`Readiness support approved`, text=~`Delivery Partner` , textinfo='text',rotation=140, showlegend=F) %>%
  layout(title="",
           legend=list(orientation='h', x=0, y=-0.9))
)
```

row
-----------------------------------------------
### Readiness Support
```{r}

  bscols(
      plot_ly(shared_df, x=~countryname,y=~`Readiness support approved`, showlegend=F)%>%
          plotly::layout(title='', xaxis = list(title = "", tickangle=90, tickfont=list(size=12)),yaxis=list( tickfont=list(size=14), title='Amount ((Million USD)', titlefont=list(size=14)))
  )
```

### Readiness Approval Timeline
```{r}

  bscols(widths = c(3,10),
    list(filter_slider("Time in Months","Time to approve (Months)",shared_df,~`Time-to-approve (Months)`, min = 0, max = 40)),
    plot_ly(shared_df, color = I("grey60"))%>%
  add_segments(y = ~`Date of initial submission`, yend = ~Approval, x = ~countryname, xend = ~countryname, showlegend = FALSE) %>%
  add_segments(y = ~`Date of initial submission`, yend = ~`Last date of resubmission`, x = ~countryname, xend = ~countryname, showlegend = FALSE) %>% 
  add_segments(y = ~`Last date of resubmission`, yend = ~Approval, x = ~countryname, xend = ~countryname, showlegend = FALSE)%>%
  add_markers(y = ~`Date of initial submission`, x = ~countryname, name = "Initial submission", color = I("red"))%>% 
                add_markers(y = ~`Last date of resubmission`, x = ~countryname, name = "Resubmission", color = I("blue"))%>% 
                add_markers(y = ~Approval, x = ~countryname, name = "Approval", color = I("green"))%>% 
                layout(title = "", xaxis = list(title = ""), yaxis = list(title = "Date"),legend=list(orientation='v', x=0.96,y=0),
                       margin = list(l = 10))
  )
```


##### Projects
__To do:__ check if we have links to project websites or project files somewhere

```{r}
library(DT)
#GCF_projects$`Project Name`<-paste('<a href=',GCF_projects$Link, '>',GCF_projects$`Project Name`,'</a>', sep = "")

colnames(GCF_projects)[colnames(GCF_projects)=='countryname']<-'Country'
colnames(GCF_projects)[colnames(GCF_projects)=='Region_init']<-'Region'

proj<-GCF_projects[,c(2,3,5,8,10)]
datatable(proj,filter = 'top',selection = 'multiple',callback = JS("return table;"), fillContainer = T,rownames = F, editable = F, style = 'jqueryui', class = 'display responsive', width = '100%', caption = "GCF Projects", extensions = 'Buttons', options=list(initComplete = JS("function(settings, json) {$(this.api().table().header()).css({'font-size' : '70%'});}"),pageLength= 10, dom='lfrtipB', buttons = c('copy', 'csv', 'excel', 'pdf')), escape = F)%>%
  DT::formatStyle(columns = colnames(proj),fontSize= '12px')


```


Explore with pivot table
=================================================
__Hint__
Select desired graphic to draw from the drop-down menu on the first column   
Drag-&-Drop the variable(s) of interest from the first column into the second column,    
Then from the drop down menu on the second column select how you want to represent your values e.g as a Count, Sum, List, etc   

```{r}
rpivotTable(data=tracker, cols =~Country,   rendererName ='Horizontal Stacked Bar Chart' )
#rows = ~Measure,vals = 'Measure', aggregatorName = 'Count Unique Values',
```




